{% extends "layout.html" %}

{% block body %}
<h2>Add BibTeX reference</h2>
<p>Select type and fill in the fields. Fields marked * are required for the chosen type.</p>

<div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 12px;">
  <form method="GET" action="{{ url_for('new') }}">
    <input
      type="text"
      name="doi"
      id="doi-input"
      placeholder="https://doi.org/10.xxxx/xxxx"
      style="width: 100%; max-width: 360px;"
      value="{{ request.args.get('doi', '') }}"
    >
    <button type="submit" style="margin-top: 8px;">Fill from DOI</button>
  </form>
</div>

<form action="/create_references" method="POST">
  <p>
    Type:<br>
    {% for type in field_map.keys() %}
      <label>
        <input
          type="radio"
          name="entry_type"
          value="{{ type }}"
          id="entry_type_{{ type }}"
          {% if existing_data and existing_data.entry_type == type %}checked{% elif not existing_data and loop.first %}checked{% endif %}>
        {{ type.capitalize() }}
      </label>
    {% endfor %}
  </p>

  <h3 id="type-heading">Book</h3>

  <p>
    <label for="citekey">CiteKey *</label><br>
    <input type="text" name="citekey" id="citekey" value="{{ citekey_prefill or '' }}" required>
  </p>

  <div id="fields-container"></div>

  <p>
    <button type="submit">Save</button>
    <a href="/">Back</a>
  </p>
</form>

{% if reference_created %}
  <p style="color: green;">Reference added</p>
{% endif %}

{% if error_message %}
  <p style="color: red;">{{ error_message }}</p>
{% endif %}

<script>
  window.FIELD_MAP = {{ field_map | tojson }};
  window.EXISTING_DATA = {{ existing_data | tojson }};
</script>
<script src="{{ url_for('static', filename='form_fields.js') }}"></script>
{% endblock %}
