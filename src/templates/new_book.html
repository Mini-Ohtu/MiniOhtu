{% extends "layout.html" %}

{% block body %}
<div class="text-center mb-3">
  <h2>Add BibTeX reference</h2>
  <p>Select type and fill in the fields. Fields marked * are required for the chosen type.</p>
</div>

<div class="card mb-3 mx-auto" style="max-width: 720px;">
  <div class="card-body">
    <form
      method="GET"
      action="{{ url_for('new') }}"
      class="d-flex flex-column flex-sm-row gap-2 align-items-sm-center"
    >
      <input
        type="text"
        name="doi"
        id="doi-input"
        class="form-control"
        placeholder="https://doi.org/10.xxxx/xxxx"
        value="{{ request.args.get('doi', '') }}"
      >
      <button type="submit" class="btn btn-outline-primary">Fill from DOI</button>
    </form>
  </div>
</div>

<div class="card mb-3 reference-card mx-auto" style="max-width: 720px;">
  <div class="card-body">
    <form action="/create_references" method="POST">
      <div class="mb-3">
        Type:<br>
        <div class="mb-2">
          {% for type in field_map.keys() %}
            <label class="me-2">
              <input
                type="radio"
                name="entry_type"
                value="{{ type }}"
                id="entry_type_{{ type }}"
                {% if existing_data and existing_data.entry_type == type %}checked{% elif not existing_data and loop.first %}checked{% endif %}>
              {{ type.capitalize() }}
            </label>
          {% endfor %}
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 id="type-heading" class="mb-0 flex-grow-1">Book</h3>
        <div class="d-flex gap-2">
          <button class="btn btn-success" type="submit">Save</button>
          <a href="/" class="btn btn-secondary">Back</a>
        </div>
      </div>

      {% if reference_created %}
        <p class="text-success">Reference added</p>
      {% endif %}

      {% if error_message %}
        <p class="text-danger">{{ error_message }}</p>
      {% endif %}

      <div class="mb-3">
        <label class="form-label" for="citekey">CiteKey *</label>
        <input class="form-control" type="text" name="citekey" id="citekey" value="{{ citekey_prefill or '' }}" required>
      </div>

      <div id="fields-container"></div>
    </form>
  </div>
</div>

<script>
  window.FIELD_MAP = {{ field_map | tojson }};
  window.EXISTING_DATA = {{ existing_data | tojson }};
</script>
<script src="{{ url_for('static', filename='form_fields.js') }}"></script>
{% endblock %}
